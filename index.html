<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>éŸ³å£° å·¦å³åˆ†é›¢ï¼†æ³¢å½¢è¡¨ç¤º (MP4/WAVå¯¾å¿œ)</title>
  <style>
    canvas {
      width: 100%;
      height: 100px;
      background: #111;
      display: block;
      margin: 10px 0;
    }
    body {
      font-family: sans-serif;
      padding: 20px;
      background: #222;
      color: white;
    }
  </style>
</head>
<body>
  <h2>ğŸ§ éŸ³å£°ã®å·¦å³ãƒãƒ£ãƒ³ãƒãƒ«ã‚’åˆ†é›¢ãƒ»æ³¢å½¢è¡¨ç¤ºï¼ˆMP4 / WAVï¼‰</h2>
  <input type="file" id="fileInput" accept="video/mp4,audio/wav" />
  <button id="play">â–¶ å†ç”Ÿ</button>

  <h3>ğŸ”Š å·¦ãƒãƒ£ãƒ³ãƒãƒ«</h3>
  <canvas id="leftCanvas" width="800" height="100"></canvas>
  <h3>ğŸ”Š å³ãƒãƒ£ãƒ³ãƒãƒ«</h3>
  <canvas id="rightCanvas" width="800" height="100"></canvas>

  <script>
    const fileInput = document.getElementById("fileInput");
    const playButton = document.getElementById("play");
    const leftCanvas = document.getElementById("leftCanvas");
    const rightCanvas = document.getElementById("rightCanvas");
    const leftCtx = leftCanvas.getContext("2d");
    const rightCtx = rightCanvas.getContext("2d");

    let audioContext = new (window.AudioContext || window.webkitAudioContext)();
    let leftBuffer = null;
    let rightBuffer = null;

    fileInput.addEventListener("change", async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const arrayBuffer = await file.arrayBuffer();

      try {
        const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);

        if (audioBuffer.numberOfChannels < 2) {
          alert("ã‚¹ãƒ†ãƒ¬ã‚ªéŸ³å£°ã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼");
          return;
        }

        const leftData = audioBuffer.getChannelData(0);
        const rightData = audioBuffer.getChannelData(1);

        leftBuffer = audioContext.createBuffer(1, leftData.length, audioBuffer.sampleRate);
        rightBuffer = audioContext.createBuffer(1, rightData.length, audioBuffer.sampleRate);
        leftBuffer.copyToChannel(leftData, 0);
        rightBuffer.copyToChannel(rightData, 0);

        drawWaveform(leftCtx, leftData, "lime");
        drawWaveform(rightCtx, rightData, "aqua");

        alert("èª­ã¿è¾¼ã¿å®Œäº†ï¼MP4ã¾ãŸã¯WAVã®ã‚¹ãƒ†ãƒ¬ã‚ªéŸ³å£°ã‚’åˆ†é›¢ã—ã¾ã—ãŸã€‚");
      } catch (err) {
        console.error(err);
        alert("éŸ³å£°ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚å½¢å¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
      }
    });

    playButton.addEventListener("click", () => {
      if (!leftBuffer || !rightBuffer) {
        alert("éŸ³å£°ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„");
        return;
      }

      const leftSource = audioContext.createBufferSource();
      const rightSource = audioContext.createBufferSource();

      leftSource.buffer = leftBuffer;
      rightSource.buffer = rightBuffer;

      const merger = audioContext.createChannelMerger(2);

      leftSource.connect(merger, 0, 0); // å·¦ãƒãƒ£ãƒ³ãƒãƒ«
      rightSource.connect(merger, 0, 1); // å³ãƒãƒ£ãƒ³ãƒãƒ«

      merger.connect(audioContext.destination);

      leftSource.start();
      rightSource.start();
    });

    function drawWaveform(ctx, data, color) {
      const width = ctx.canvas.width;
      const height = ctx.canvas.height;
      ctx.clearRect(0, 0, width, height);
      ctx.beginPath();
      ctx.strokeStyle = color;
      const step = Math.floor(data.length / width);

      for (let i = 0; i < width; i++) {
        const min = i * step;
        const max = min + step;
        let sum = 0;
        for (let j = min; j < max && j < data.length; j++) {
          sum += data[j];
        }
        const avg = sum / step;
        const y = height / 2 - avg * height / 2;
        if (i === 0) ctx.moveTo(i, y);
        else ctx.lineTo(i, y);
      }
      ctx.stroke();
    }
  </script>
</body>
</html>
